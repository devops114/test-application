
version: 0.2

env:
  variables:
    API_URL: "https://2r1jycdqag.execute-api.us-east-1.amazonaws.com/Prod/detect-errors/"

phases:
  install:
    commands:
      - apt-get update -y
      - apt-get install -y jq

  build:
    commands:
      - echo "Running calculator application..."
      - python calculator.py 2>&1 | tee build.log

  post_build:
    commands:
      - echo "Preparing logs for AI analysis..."
      - LOG_LINES=$(cat build.log | sed 's/"/\\"/g' | tr '\n' '|')
      - JSON_PAYLOAD="{\"log_lines\": [\"${LOG_LINES//|/\",\"}\"]}"
      - JSON_PAYLOAD=${JSON_PAYLOAD%,\"]}
      - JSON_PAYLOAD=${JSON_PAYLOAD}\"]}

      - echo "Sending logs to AI API..."
      - RESPONSE=$(curl -s -X POST "$API_URL" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
      
      - echo "AI Response:"
      - echo "$RESPONSE" | jq .

      - ERRORS_FOUND=$(echo "$RESPONSE" | jq -r '.errors_found')
      - if [ "$ERRORS_FOUND" = "true" ]; then
          echo "AI detected errors! Build failed."
          exit 1
        else
          echo "No errors detected. Build succeeded."
        fi
